parameters:
  os: ''

steps:

# Clean
- checkout: self
  clean: true

# Only when building on Windows:
- ${{ if eq(parameters.os, 'Windows_NT') }}:

  # Start collect diagnostics
  - powershell: ./_CI/start-collect-diagnostics.ps1
    displayName: Start collect diagnostics
    condition: and(succeeded(), eq(variables.collect_diagnostics, 'true'))

- task: PowerShell
  displayName: 'Install Pester'
  inputs:
    targetType: 'inline'
    script: 'Install-Module -Name Pester -SkipPublisherCheck -Force -Verbose -Scope CurrentUser'

- task: PowerShell@2
  displayName: 'Install PSScriptAnalyzer'
  inputs:
    targetType: 'inline'
    script: 'Install-Module -Name PSScriptAnalyzer -SkipPublisherCheck -Force -Verbose -Scope CurrentUser'


- task: PowerShell@2
  displayName: 'Run PSScriptAnalyzer'
  inputs:
    targetType: 'inline'
    script: 'Invoke-ScriptAnalyzer -Path .\'

# Only when building on Windows:
- ${{ if eq(parameters.os, 'Windows_NT') }}:

  # Stop collect diagnostics
  - powershell: ./_CI/stop-collect-diagnostics.ps1
    displayName: Stop collect diagnostics
    condition: and(always(), eq(variables.collect_diagnostics, 'true'), ne(variables['numTasks'], 0))
